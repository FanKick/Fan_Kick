{% extends "base.html" %}
{% load static %}
{% load user_tags %}

{% block content %}
<link rel="stylesheet" href="{% static 'contents/contents_navbar.css' %}">
<link rel="stylesheet" href="{% static 'contents/player_feed.css' %}">
<link rel="stylesheet" href="{% static 'contents/create_post.css' %}">
<link rel="stylesheet" href="{% static 'contents/modal.css' %}">

<div class="container-navbar">
    <div class="nav-item">
        <a href="{% url 'user_post_list' team_id %}" class="{% if request.path == '/contents/team/'|add:team_id|add:'/user_post_list/' %}active{% endif %}">Feed</a>
    </div>
    <div class="nav-item">
        <a href="{% url 'player_post_list' team_id %}" class="{% if request.path == '/contents/team/'|add:team_id|add:'/player_post_list/' %}active{% endif %}">Player</a>
    </div>
</div>

<!-- Hidden input for team ID -->
<input type="hidden" id="team-id" value="{{ team_id }}">

<!-- 피드 작성란 -->
<div class="container-298 post-create-container">
    {% if request.user.is_authenticated and request.user|user_is_role:'player' %}
    <div class="container-298 post-create-input" id="post-create-input">
        <div class="container-298 profile-button">
            <div class="container-298 profile-icon">
                <img src="{% if request.user.profile_image %}{{ request.user.profile_image.url }}{% else %}{% static 'contents/Frame.png' %}{% endif %}" alt="Profile Image" class="container-298 profile-icon-inner">
            </div>
        </div>
        <div class="container-298 post-create-text">
            <input type="text" placeholder="자신의 포스트를 남겨보세요." class="container-298 post-create-input-field">
            <div class="container-298 post-create-icon">
                <img src="{% static 'contents/Image.png' %}" alt="Post Icon" class="post-icon">
            </div>
        </div>
    </div>
    {% else %}
    <div class="empty-space"></div>  <!-- 여백 추가 -->
    {% endif %}
</div>

<!-- 모달 -->
<div class="modal hidden" id="post-create-modal">
    <div class="modal-content">
        <div class="modal-header">
            <div class="modal-title">포스트 쓰기</div>
            <div class="modal-close-button" id="modal-close">
                <img src="{% static 'contents/E remove.png' %}" alt="Close Icon" class="modal-close-icon">
            </div>
        </div>
        <div class="modal-username">
            <div class="modal-username-inner">
                <div class="modal-username-text">{{ request.user.username }}</div>
            </div>
        </div>
        <div class="modal-editor-container" id="modal-editor-container">
            <textarea class="modal-editor" id="modal-editor" placeholder="팬픽에 남겨보세요..."></textarea>
        </div>
        <!-- 파일 정보 표시 영역 -->
        <div class="file-info" id="file-info"></div>
        
        <div class="modal-divider"></div>
        <button type="button" class="modal-button" id="modal-submit-button">
            <div class="modal-button-text">등록</div>
        </button>
        <div class="modal-img-button" id="modal-img-button">
            <img src="{% static 'contents/Image.png' %}" alt="Cancel Button">
        </div>
        
        <!-- 이미지 파일 입력 필드 -->
        <input type="file" id="image-input" class="hidden" accept="image/*" multiple>
    </div>
</div>

<!-- 포스트와 팀 섹션 -->
<div class="container-297">
    <div class="container-297-inner">
        <!-- 기존 포스트들 -->
        {% for post in posts %}
        <div class="container-297-post">
            <div class="container-297-profile">
                <div class="profile-button">
                    <div class="profile-icon">
                        {% if post.user.profile %}
                            <!-- Assume all profiles are stored in media/profiles -->
                            <img src="/media/profiles/{{ post.user.profile.name }}" alt="Profile Image" class="container-297 profile-icon-inner">
                        {% else %}
                            <img src="{% static 'contents/Frame.png' %}" alt="Profile Image" class="container-297 profile-icon-inner">
                        {% endif %}
                    </div>
                </div>
                <div class="username-date">
                    <div class="username">{{ post.user.username }}</div>
                    <div class="post-date">
                        <div class="date-text">{{ post.created_at|date:"m.d H:i" }}</div>
                    </div>
                </div>
            </div>
            <div class="container-297-post-details">
                <p>{{ post.content }}</p>
                {% if post.images.exists %}
                <ul class="post-images-grid" data-image-count="{{ post.images.count }}">
                    {% for image in post.images.all %}
                    <li class="post-image-item"><img class="post-image" src="{{ image.image_url.url }}" /></li>
                    {% endfor %}
                </ul>
                {% endif %}
                <div class="post-footer">
                    <div class="like-comment-container">
                        <div class="icon-container">
                            <img src="{% static 'contents/like.png' %}" alt="Like Icon" class="icon-like">
                        </div>
                        <div class="count">{{ post.likes.count }}</div>
                        <div class="icon-container">
                            <img src="{% static 'contents/comment.png' %}" alt="Comment Icon" class="icon-comment">
                        </div>
                        <div class="count">{{ post.comments.count }}</div>
                    </div>
                </div>
                <div class="divider"></div> <!-- 각 포스트 사이의 구분선 -->
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- URL 확인용 -->
<script>
    console.log("{% url 'create_post_user' %}");
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    var inputField = document.getElementById('post-create-input');
    var modal = document.getElementById('post-create-modal');
    var closeBtn = document.getElementById('modal-close');
    var imgBtn = document.getElementById('modal-img-button');
    var imageInput = document.getElementById('image-input');
    var fileInfo = document.getElementById('file-info');
    var submitBtn = document.getElementById('modal-submit-button');
    var joinButton = document.getElementById('join-community');

    // 페이지 로드 시 모달을 숨깁니다.
    modal.classList.add('hidden');
    modal.style.display = "none";  // 모달을 숨김

    // "자신의 포스트를 남겨보세요." 클릭 시 모달을 표시합니다.
    if (inputField) {
        inputField.addEventListener('click', function() {
            modal.classList.remove('hidden');
            modal.style.display = "flex";  // 모달을 표시
        });
    }

    // 모달 닫기 버튼 클릭 시 모달을 숨깁니다.
    if (closeBtn) {
        closeBtn.addEventListener('click', function() {
            modal.classList.add('hidden');
            modal.style.display = "none";  // 모달을 숨김
        });
    }

    // 모달 이미지 버튼 클릭 시 파일 선택 창을 엽니다.
    if (imgBtn) {
        imgBtn.addEventListener('click', function() {
            imageInput.click();  // 파일 선택 창을 엽니다.
        });
    }

    // 파일 선택 창에서 파일 선택 시 최대 3개의 파일만 선택할 수 있도록 합니다.
    imageInput.addEventListener('change', function() {
        var files = imageInput.files;
        if (files.length > 3) {
            alert("최대 3개의 이미지만 선택할 수 있습니다.");
            imageInput.value = "";  // 파일 선택 초기화
        } else {
            displayFileInfo(files);
        }
    });

    // 파일 정보를 표시하는 함수
    function displayFileInfo(files) {
        fileInfo.innerHTML = '';  // 기존 파일 정보 초기화
        for (var i = 0; i < files.length; i++) {
            var file = files[i];
            var fileElement = document.createElement('div');
            fileElement.textContent = file.name + ' (' + Math.round(file.size / 1024) + ' KB)';
            fileInfo.appendChild(fileElement);
        }
    }

    // 폼 제출 시 AJAX 요청을 보냅니다.
    submitBtn.addEventListener('click', function() {
        var formData = new FormData();
        formData.append('content', document.getElementById('modal-editor').value);
        
        var files = imageInput.files;
        for (var i = 0; i < files.length; i++) {
            formData.append('images', files[i]);
        }

        formData.append('team_id', document.getElementById('team-id').value);

        fetch("{% if request.user.role == 'player' %}{% url 'create_post_player' %}{% else %}{% url 'create_post_user' %}{% endif %}", {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                modal.classList.add('hidden');
                modal.style.display = "none";  // 모달을 숨김
                location.reload();  // 페이지를 새로고침하여 새로운 포스트를 표시
            } else {
                alert('포스트 작성에 실패했습니다.');
            }
        })
        .catch(error => {
            console.error('Error:', error);
        });
    });

    // 모달 외부 클릭 시 모달을 숨깁니다.
    window.addEventListener('click', function(event) {
        if (event.target === modal) {
            modal.classList.add('hidden');
            modal.style.display = "none";  // 모달을 숨김
        }
    });

    // 이미지 개수에 따라 그리드 클래스 추가
    var imageGrids = document.querySelectorAll('.post-images-grid');
    imageGrids.forEach(function(grid) {
        var imageCount = grid.getAttribute('data-image-count');
        if (imageCount == 1) {
            grid.classList.add('grid-1');
        } else if (imageCount == 2) {
            grid.classList.add('grid-2');
        } else if (imageCount == 3) {
            grid.classList.add('grid-3');
        }
    });
});
</script>

{% endblock %}
